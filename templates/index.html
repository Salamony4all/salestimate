<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PDF Processor Pro</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            padding-top: 40px;
            padding-bottom: 40px;
        }
        .thumbnail-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        .thumbnail-wrapper {
            text-align: center;
            cursor: pointer;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: .375rem;
            transition: border-color 0.2s;
            position: relative; /* For checkbox positioning */
        }
        .thumbnail-wrapper.selected {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, .25);
        }
        .thumbnail-wrapper img {
            max-width: 200px;
            height: auto;
            border-radius: .25rem;
        }
        .thumbnail-wrapper .page-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
        }
        .thumbnail-wrapper p {
            margin-top: 10px;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-5">
            <h1>PDF Processor Pro</h1>
            <p class="lead">From Complex PDFs to Actionable Data</p>
        </div>

        <!-- Step 1: Upload and Convert -->
        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex align-items-center">
                <span class="badge bg-primary rounded-pill me-3">1</span>
                <h5 class="mb-0">Convert PDF to Images</h5>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <input type="file" class="form-control" name="file" id="pdf-file" required accept="application/pdf">
                    <button class="btn btn-primary" type="button" id="convert-btn">Convert</button>
                    <div class="spinner-border text-primary ms-3" role="status" id="pdf-spinner" style="display:none;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Select Pages and Options -->
        <div id="image-results-card" class="card shadow-sm mb-4" style="display:none;">
            <div class="card-header d-flex align-items-center">
                <span class="badge bg-primary rounded-pill me-3">2</span>
                <h5 class="mb-0">Select Pages & Extraction Options</h5>
            </div>
            <div class="card-body">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="select-all-pages">
                    <label class="form-check-label" for="select-all-pages">Select All Pages</label>
                </div>
                <div id="thumbnail-container"></div>
            </div>
            <div class="card-footer">
                <h6 class="mb-3">Fine-Tuning Options</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" name="useTableRecognition" id="useTableRecognition" checked>
                            <label class="form-check-label" for="useTableRecognition">Recognize Tables</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="useDocUnwarping" id="useDocUnwarping">
                            <label class="form-check-label" for="useDocUnwarping">Correct Image Distortion</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="htmlConversion" id="wired" value="useWiredTableCellsTransToHtml" checked>
                            <label class="form-check-label" for="wired">Wired Table to HTML</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="htmlConversion" id="borderless" value="useWirelessTableCellsTransToHtml">
                            <label class="form-check-label" for="borderless">Borderless Table to HTML</label>
                        </div>
                    </div>
                </div>
                 <button type="button" id="extract-tables-btn" class="btn btn-success w-100 mt-4">Extract and Collate Tables</button>
            </div>
        </div>

        <!-- Step 3: Extraction Progress -->
        <div id="extraction-progress-card" class="card shadow-sm mb-4" style="display:none;">
            <div class="card-header d-flex align-items-center">
                 <span class="badge bg-primary rounded-pill me-3">3</span>
                 <h5 class="mb-0">Extracting & Collating...</h5>
            </div>
            <div class="card-body">
                <p>Processing page <span id="current-page-num">0</span> of <span id="total-pages-num">0</span></p>
                <div class="progress" style="height: 25px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <div class="text-center mt-3">
                    <div class="spinner-border text-success" id="table-spinner" role="status">
                        <span class="visually-hidden">Extracting...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Results -->
        <div id="table-results-container" class="card shadow-sm" style="display:none;">
             <div class="card-header d-flex align-items-center">
                <span class="badge bg-primary rounded-pill me-3">4</span>
                <h5 class="mb-0">Results</h5>
            </div>
            <div class="card-body">
                <h6 class="card-title">Collated Table</h6>
                <div class="table-responsive">
                    <table id="collated-table" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
             <div class="card-footer">
                <h6 class="card-title">Summary</h6>
                <pre id="summary-output" class="mb-0"></pre>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <!-- DataTables JS -->
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <script>
    $(document).ready(function () {
        const pdfFileInput = $('#pdf-file');
        const convertBtn = $('#convert-btn');
        const pdfSpinner = $('#pdf-spinner');
        const imageResultsCard = $('#image-results-card');
        const thumbnailContainer = $('#thumbnail-container');
        const selectAllCheckbox = $('#select-all-pages');
        const extractTablesBtn = $('#extract-tables-btn');
        const extractionProgressCard = $('#extraction-progress-card');
        const progressBar = $('#progress-bar');
        const currentPageNum = $('#current-page-num');
        const totalPagesNum = $('#total-pages-num');
        const tableSpinner = $('#table-spinner');
        const tableResultsContainer = $('#table-results-container');
        const summaryOutput = $('#summary-output');
        let dt = null;

        function showAlert(message, type = 'danger') {
            const alertHtml = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                                ${message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                           </div>`;
            $('.container').prepend(alertHtml);
        }

        function displayThumbnails(imageUrls) {
            thumbnailContainer.html('');
            imageUrls.forEach((url, i) => {
                const wrapper = $('<div>').addClass('thumbnail-wrapper').data('imageUrl', url).data('pageNumber', i + 1);
                const checkbox = $('<input>').attr('type', 'checkbox').addClass('page-checkbox form-check-input');
                const img = $('<img>').attr('src', url);
                const pageNum = $('<p>').text(`Page ${i + 1}`);

                wrapper.on('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                         checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
                    }
                });
                
                checkbox.on('change', function() {
                    wrapper.toggleClass('selected', $(this).prop('checked'));
                });

                wrapper.append(checkbox, img, pageNum);
                thumbnailContainer.append(wrapper);
            });
        }

        function calculateSummary(data, headers) {
            let totalAmount = 0;
            const amountColumnIndex = headers.findIndex(h => h.toLowerCase().includes('amount'));
            if (amountColumnIndex === -1) return "Could not find an 'Amount' column for summary.";
            
            data.forEach(row => {
                const cellValue = row[amountColumnIndex];
                if (cellValue) {
                    const value = parseFloat(String(cellValue).trim().replace(/<[^>]*>/g, '').replace(/,/g, ''));
                    if (!isNaN(value)) totalAmount += value;
                }
            });
            return `Total Items: ${data.length}
Total Amount: ${totalAmount.toFixed(2)}`;
        }

        convertBtn.on('click', async () => {
            if (!pdfFileInput.prop('files').length) return showAlert('Please select a PDF file.');
            const formData = new FormData();
            formData.append('file', pdfFileInput.prop('files')[0]);
            
            pdfSpinner.show();
            imageResultsCard.hide();

            try {
                const response = await fetch('/process_pdf', { method: 'POST', body: formData });
                const data = await response.json();
                if (response.ok && data.image_urls) {
                    displayThumbnails(data.image_urls);
                    imageResultsCard.show();
                    imageResultsCard[0].scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert(data.error || 'PDF to image conversion failed.');
                }
            } catch (error) {
                showAlert('An unexpected error occurred during PDF conversion.');
            } finally {
                pdfSpinner.hide();
            }
        });

        selectAllCheckbox.on('change', function() {
            const isChecked = $(this).prop('checked');
            $('.page-checkbox').prop('checked', isChecked).trigger('change');
        });

        extractTablesBtn.on('click', async () => {
            const selectedWrappers = $('.thumbnail-wrapper.selected');
            if (selectedWrappers.length === 0) return showAlert('Please select at least one page to process.');

            const options = {};
            $('#fine-tuning-options input[type="checkbox"]:checked').each(function() { options[this.name] = true; });
            const selectedHtmlConversion = $('#fine-tuning-options input[name="htmlConversion"]:checked').val();
            if(selectedHtmlConversion) options[selectedHtmlConversion] = true;

            extractionProgressCard.show();
            extractionProgressCard[0].scrollIntoView({ behavior: 'smooth' });
            tableResultsContainer.hide();
            totalPagesNum.text(selectedWrappers.length);

            const allHtmlParts = [];
            const allImageMaps = [];
            let processedCount = 0;

            for (const wrapper of selectedWrappers.get()) {
                processedCount++;
                currentPageNum.text(processedCount);
                const progress = (processedCount / selectedWrappers.length) * 100;
                progressBar.css('width', `${progress}%`).attr('aria-valuenow', progress).text(`${Math.round(progress)}%`);
                
                try {
                    const imageResponse = await fetch($(wrapper).data('imageUrl'));
                    const imageBlob = await imageResponse.blob();
                    const formData = new FormData();
                    formData.append('image', imageBlob, `page_${$(wrapper).data('pageNumber')}.png`);
                    formData.append('options', JSON.stringify(options));

                    const extractResponse = await fetch('/extract_tables', { method: 'POST', body: formData });
                    const data = await extractResponse.json();

                    if (extractResponse.ok && data.html) {
                        allHtmlParts.push(data.html);
                        if (data.images) allImageMaps.push(data.images);
                    } else {
                        console.warn(`Could not extract table from page ${$(wrapper).data('pageNumber')}.`);
                    }
                } catch (error) {
                    console.error(`Error processing page ${$(wrapper).data('pageNumber')}:`, error);
                }
            }

            try {
                const collateResponse = await fetch('/collate_tables', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ html_parts: allHtmlParts, image_maps: allImageMaps })
                });
                const collateData = await collateResponse.json();

                if (collateResponse.ok && collateData.headers && collateData.data) {
                    if(dt) dt.destroy();
                    $('#collated-table thead tr').empty();
                    
                    collateData.headers.forEach(headerText => {
                        $('#collated-table thead tr').append($('<th>').text(headerText));
                    });

                    dt = $('#collated-table').DataTable({
                        data: collateData.data,
                        columns: collateData.headers.map(header => ({ "title": header })),
                        paging: true,
                        searching: true,
                        ordering: true,
                        info: true,
                        responsive: true,
                        "createdRow": (row, data, dataIndex) => {
                            data.forEach((cellData, index) => {
                                $(row).find('td').eq(index).html(cellData);
                            });
                        }
                    });

                    summaryOutput.text(calculateSummary(collateData.data, collateData.headers));
                    tableResultsContainer.show();
                    tableResultsContainer[0].scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert(collateData.error || 'Failed to collate tables.', 'warning');
                }
            } catch (error) {
                 showAlert('An error occurred while collating tables.', 'danger');
            } finally {
                extractionProgressCard.hide();
            }
        });
    });
    </script>
</body>
</html>
