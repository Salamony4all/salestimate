
<!doctype html>
<title>PDF Processor</title>
<style>
    body { font-family: sans-serif; line-height: 1.6; padding: 20px; max-width: 1200px; margin: auto; }
    .card { border: 1px solid #ccc; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h1, h2, h3 { color: #333; }
    input[type=file], input[type=checkbox] { margin-bottom: 10px; }
    button { background-color: #007BFF; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    .thumbnail-container { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
    .thumbnail-wrapper { text-align: center; cursor: pointer; padding: 5px; border: 2px solid #ddd; transition: border-color 0.2s; }
    .thumbnail-wrapper.selected { border-color: #007BFF; }
    .thumbnail-wrapper img { max-width: 200px; height: auto; }
    .thumbnail-wrapper p { margin-top: 5px; font-size: 14px; color: #555; }
    .spinner { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-left: 20px; vertical-align: middle; }
    .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;}
    #table-result-preview { border: 1px solid #ccc; padding: 10px; margin-top: 10px; overflow-x: auto; }
    #table-result-preview table { border-collapse: collapse; width: 100%; }
    #table-result-preview th, #table-result-preview td { border: 1px solid #ddd; padding: 8px; }
    #progress-container { display: none; margin-top: 20px; }
    #progress-bar { width: 0%; height: 20px; background-color: #4CAF50; text-align: center; line-height: 20px; color: white; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<h1>PDF Processor</h1>

<div class="card">
    <h2>1. Convert PDF to Images</h2>
    <input type="file" name="file" id="pdf-file" required accept="application/pdf">
    <button type="button" id="convert-btn">Convert</button>
    <div class="spinner" id="pdf-spinner"></div>
</div>

<div id="image-results-card" class="card" style="display:none;">
    <h2>Converted Pages</h2>
    <p>Select the pages you want to include in the final table.</p>
    <label><input type="checkbox" id="select-all-pages"> Select All</label>
    <div id="thumbnail-container" class="thumbnail-container"></div>
    <button type="button" id="extract-tables-btn" style="margin-top: 15px;">Extract and Collate Tables</button>
</div>

<div id="extraction-progress-card" class="card" style="display:none;">
    <h2>2. Extracting & Collating...</h2>
    <div id="progress-container">
        <p>Processing page <span id="current-page-num">0</span> of <span id="total-pages-num">0</span></p>
        <div style="border: 1px solid #ccc;">
            <div id="progress-bar">0%</div>
        </div>
    </div>
    <div class="spinner" id="table-spinner" style="margin-top: 15px;"></div>
</div>

<div id="table-results-container" class="card" style="display:none;">
    <h3>Extraction Results</h3>
    <h4>Collated Table</h4>
    <div id="table-result-preview"></div>
    <h4>Summary</h4>
    <pre id="summary-output"></pre>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
    const pdfFileInput = document.getElementById('pdf-file');
    const convertBtn = document.getElementById('convert-btn');
    const pdfSpinner = document.getElementById('pdf-spinner');
    const imageResultsCard = document.getElementById('image-results-card');
    const thumbnailContainer = document.getElementById('thumbnail-container');
    const selectAllCheckbox = document.getElementById('select-all-pages');
    const extractTablesBtn = document.getElementById('extract-tables-btn');
    const extractionProgressCard = document.getElementById('extraction-progress-card');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const currentPageNum = document.getElementById('current-page-num');
    const totalPagesNum = document.getElementById('total-pages-num');
    const tableSpinner = document.getElementById('table-spinner');
    const tableResultsContainer = document.getElementById('table-results-container');
    const tableResultPreview = document.getElementById('table-result-preview');
    const summaryOutput = document.getElementById('summary-output');

    function showAlert(message) { alert(message); }

    function displayThumbnails(imageUrls) {
        thumbnailContainer.innerHTML = '';
        imageUrls.forEach((url, i) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'thumbnail-wrapper';
            wrapper.dataset.imageUrl = url;
            wrapper.dataset.pageNumber = i + 1;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'page-checkbox';
            checkbox.style.position = 'absolute';

            const img = document.createElement('img');
            img.src = url;

            const pageNum = document.createElement('p');
            pageNum.textContent = `Page ${i + 1}`;

            wrapper.addEventListener('click', (e) => {
                if (e.target.type !== 'checkbox') checkbox.checked = !checkbox.checked;
                wrapper.classList.toggle('selected', checkbox.checked);
            });
            
            wrapper.appendChild(checkbox);
            wrapper.appendChild(img);
            wrapper.appendChild(pageNum);
            thumbnailContainer.appendChild(wrapper);
        });
    }

    function calculateSummaryFromHtml(tableHtml) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = tableHtml;
        const table = tempDiv.querySelector('table');
        if (!table) return "Summary could not be generated.";

        let totalAmount = 0;
        const rows = table.querySelectorAll('tbody tr');
        let amountColumnIndex = -1;

        const headers = table.querySelectorAll('thead th');
        headers.forEach((th, index) => {
            if (th.textContent.trim().toLowerCase().includes('amount')) {
                amountColumnIndex = index;
            }
        });

        if (amountColumnIndex === -1) return "Could not find 'Amount' column.";

        rows.forEach(row => {
            const cell = row.cells[amountColumnIndex];
            if (cell) {
                const value = parseFloat(cell.textContent.trim().replace(/,/g, ''));
                if (!isNaN(value)) totalAmount += value;
            }
        });

        return `Total Items: ${rows.length}\nTotal Amount: ${totalAmount.toFixed(2)}`;
    }

    convertBtn.addEventListener('click', async () => {
        if (!pdfFileInput.files.length) return showAlert('Please select a PDF file.');
        const formData = new FormData();
        formData.append('file', pdfFileInput.files[0]);

        pdfSpinner.style.display = 'inline-block';
        imageResultsCard.style.display = 'none';

        try {
            const response = await fetch('/process_pdf', { method: 'POST', body: formData });
            const data = await response.json();

            if (response.ok && data.image_urls) {
                displayThumbnails(data.image_urls);
                imageResultsCard.style.display = 'block';
            } else {
                showAlert(data.error || 'PDF to image conversion failed.');
            }
        } catch (error) {
            showAlert('An unexpected error occurred during PDF conversion.');
        } finally {
            pdfSpinner.style.display = 'none';
        }
    });

    selectAllCheckbox.addEventListener('change', (e) => {
        document.querySelectorAll('.page-checkbox').forEach(checkbox => {
            checkbox.checked = e.target.checked;
            checkbox.parentElement.classList.toggle('selected', checkbox.checked);
        });
    });

    extractTablesBtn.addEventListener('click', async () => {
        const selectedWrappers = Array.from(document.querySelectorAll('.thumbnail-wrapper.selected'));
        if (selectedWrappers.length === 0) return showAlert('Please select at least one page.');

        extractionProgressCard.style.display = 'block';
        progressContainer.style.display = 'block';
        tableSpinner.style.display = 'inline-block';
        tableResultsContainer.style.display = 'none';
        totalPagesNum.textContent = selectedWrappers.length;

        const allMarkdownResults = [];
        let processedCount = 0;

        for (const wrapper of selectedWrappers) {
            processedCount++;
            currentPageNum.textContent = processedCount;
            const progress = (processedCount / selectedWrappers.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${Math.round(progress)}%`;
            
            try {
                const imageResponse = await fetch(wrapper.dataset.imageUrl);
                const imageBlob = await imageResponse.blob();
                
                const formData = new FormData();
                formData.append('image', imageBlob, `page_${wrapper.dataset.pageNumber}.png`);
                formData.append('options', JSON.stringify({ "useTableRecognition": true }));

                const extractResponse = await fetch('/extract_tables', { method: 'POST', body: formData });
                const data = await extractResponse.json();

                if (extractResponse.ok && data.markdown_text) {
                    allMarkdownResults.push(data.markdown_text);
                } else {
                    console.warn(`Could not extract table from page ${wrapper.dataset.pageNumber}.`);
                }
            } catch (error) {
                console.error(`Error processing page ${wrapper.dataset.pageNumber}:`, error);
            }
        }

        // Now, send all the markdown to the backend for collation
        try {
            const collateResponse = await fetch('/collate_tables', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ markdown_parts: allMarkdownResults })
            });
            const collateData = await collateResponse.json();

            if (collateResponse.ok && collateData.collated_html) {
                tableResultPreview.innerHTML = collateData.collated_html;
                summaryOutput.textContent = calculateSummaryFromHtml(collateData.collated_html);
                tableResultsContainer.style.display = 'block';
            } else {
                showAlert(collateData.error || 'Failed to collate tables.');
            }
        } catch (error) {
             showAlert('An error occurred while collating tables.');
        } finally {
            extractionProgressCard.style.display = 'none';
            tableSpinner.style.display = 'none';
            tableResultsContainer.scrollIntoView({ behavior: 'smooth' });
        }
    });
});
</script>
